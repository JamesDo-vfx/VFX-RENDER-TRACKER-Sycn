<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>VFX Machine Render Tracker - JamesDo ZodiacII</title>
    <style>
        :root { 
            --accent: #50fa7b; --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; 
            --shot-bg: #252525; --input-bg: #1a1a1a; --delete: #ff5555;
            --sync: #bd93f9; --eta-color: #f1fa8c;
        }
        
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); color: var(--text); padding: 30px; margin: 0; }
        .container { max-width: 1550px; margin: 0 auto; }
        
        .main-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; background: var(--card); padding: 20px 40px; border-radius: 16px; border: 1px solid #333; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        h1 { color: var(--accent); margin: 0; font-size: 24px; text-transform: uppercase; letter-spacing: 2px; }
        .author-name { color: var(--accent); font-weight: bold; }

        .shot-container { background: var(--card); border-radius: 24px; padding: 30px; margin-bottom: 50px; border: 1px solid #333; position: relative; }
        .shot-header { display: flex; flex-wrap: wrap; gap: 25px; align-items: flex-end; margin-bottom: 25px; }
        
        .timeline-wrapper { position: relative; margin-bottom: 40px; }
        .timeline-labels { display: flex; justify-content: space-between; color: #666; font-size: 11px; margin-bottom: 5px; font-family: monospace; }
        .timeline-box { width: 100%; height: 50px; background: #111; border-radius: 8px; position: relative; overflow: hidden; border: 1px solid #333; }
        
        .worker-block { position: absolute; height: 100%; top: 0; border-left: 2px solid rgba(255,255,255,0.2); border-right: 2px solid rgba(255,255,255,0.2); box-sizing: border-box; }
        .worker-fill { position: absolute; left: 0; top: 0; height: 100%; opacity: 0.3; transition: width 0.3s; }
        .worker-label-min { position: absolute; width:100%; text-align:center; top: 18px; font-size: 10px; font-weight: bold; color: #fff; text-shadow: 1px 1px 2px #000; z-index: 2; pointer-events: none; overflow: hidden; white-space: nowrap; }

        .worker-row { 
            display: grid; 
            grid-template-columns: 1.2fr 0.8fr 0.8fr 1fr 1.5fr 1.2fr 0.5fr; 
            gap: 15px; background: var(--shot-bg); padding: 15px; margin-bottom: 12px; 
            border-radius: 12px; align-items: center; border-left: 5px solid;
        }

        .input-group { display: flex; flex-direction: column; gap: 5px; }
        .input-group label { font-size: 9px; color: #777; text-transform: uppercase; font-weight: bold; }
        input { background: var(--input-bg); border: 1px solid #333; color: #fff; padding: 10px; border-radius: 6px; font-size: 14px; width: 100%; box-sizing: border-box; }

        .eta-display { text-align: center; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; border: 1px solid #333; }
        .eta-time { color: var(--eta-color); font-weight: bold; font-size: 15px; font-family: monospace; display: block; }
        .prog-percent { color: var(--accent); font-weight: bold; font-size: 13px; }

        .shot-eta-box { background: rgba(241, 250, 140, 0.1); padding: 10px 20px; border-radius: 10px; border: 1px dashed var(--eta-color); }

        button { cursor: pointer; border: none; border-radius: 8px; font-weight: bold; padding: 10px 15px; text-transform: uppercase; transition: 0.2s; }
        .btn-delete { background: var(--delete); color: white; font-size: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div class="main-header">
        <h1>VFX Render Machine Tracker</h1>
        <div class="author-info"><span class="author-name">JamesDo ZodiacII</span></div>
    </div>

    <div style="margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center;">
        <p style="color: var(--accent); font-size: 12px;">üõ∞Ô∏è Status: Live Syncing from Firebase</p>
        <button style="background:transparent; color:#444; text-decoration: underline; font-size: 11px;" onclick="clearDatabase()">Clear Firebase Data</button>
    </div>

    <div id="shotList"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getDatabase, ref, onValue, remove } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

    // --- C·∫§U H√åNH FIREBASE C·ª¶A B·∫†N ---
    const firebaseConfig = {
        databaseURL: "https://vfx-machine-tracker-default-rtdb.asia-southeast1.firebasedatabase.app" // Thay b·∫±ng URL c·ªßa b·∫°n
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const colors = ['#ff79c6', '#8be9fd', '#50fa7b', '#f1fa8c', '#bd93f9', '#ffb86c'];

    function formatTime(str) { return str || "--:--:--"; }

    // H√†m x√≥a Database (D√†nh cho n√∫t Clear All)
    window.clearDatabase = () => {
        if(confirm("X√≥a to√†n b·ªô d·ªØ li·ªáu tr√™n Firebase?")) {
            remove(ref(db, 'renders'));
        }
    };

    // L·∫ÆNG NGHE D·ªÆ LI·ªÜU T·ª™ FIREBASE
    const renderRef = ref(db, 'renders');
    onValue(renderRef, (snapshot) => {
        const data = snapshot.val();
        renderAll(data);
    });

    function renderAll(data) {
        const list = document.getElementById('shotList');
        list.innerHTML = '';
        if (!data) return;

        // Nh√≥m d·ªØ li·ªáu theo Shot Name (v√¨ Firebase l∆∞u ph·∫≥ng c√°c Worker)
        const shots = {};
        Object.keys(data).forEach((key, index) => {
            const w = data[key];
            if (!shots[w.shotName]) {
                shots[w.shotName] = {
                    name: w.shotName,
                    start: w.startFrame,
                    end: w.endFrame,
                    workers: []
                };
            }
            shots[w.shotName].workers.push({
                ...w,
                color: colors[index % colors.length]
            });
        });

        // V·∫Ω giao di·ªán
        Object.values(shots).forEach(shot => {
            let totalShotETA_Sec = 0; 
            
            const workersHtml = shot.workers.map(w => {
                return `
                <div class="worker-row" style="border-left-color:${w.color}">
                    <div class="input-group"><label>Worker Name</label><input type="text" value="${w.workerName}" readonly></div>
                    <div class="input-group"><label>Start Frame</label><input type="number" value="${w.startFrame}" readonly></div>
                    <div class="input-group"><label>End Frame</label><input type="number" value="${w.endFrame}" readonly></div>
                    <div class="input-group"><label>Current Frame</label><input type="number" value="${w.currentFrame}" style="border: 1px solid var(--accent)" readonly></div>
                    <div class="input-group"><label>Node ($OS)</label><input type="text" value="${w.nodeOS || 'N/A'}" readonly></div>
                    <div class="eta-display">
                        <span class="eta-time">${w.eta}</span>
                        <span class="prog-percent">${w.progress}%</span>
                    </div>
                    <div style="font-size: 10px; color: #444">Live</div>
                </div>`;
            }).join('');

            const shotEl = document.createElement('div');
            shotEl.className = 'shot-container';
            shotEl.innerHTML = `
                <div class="shot-header">
                    <div class="input-group"><label>Shot Name</label><input type="text" style="color:var(--accent); font-weight:bold; font-size:18px" value="${shot.name}" readonly></div>
                    <div class="input-group"><label>Global Start</label><input type="number" style="width:100px" value="${shot.start}" readonly></div>
                    <div class="input-group"><label>Global End</label><input type="number" style="width:100px" value="${shot.end}" readonly></div>
                    <div class="shot-eta-box">
                        <label style="color:var(--eta-color); font-size:9px">TRACKING STATUS</label>
                        <div style="color:var(--eta-color); font-weight:bold; font-size:16px;">ACTIVE</div>
                    </div>
                </div>
                <div class="timeline-wrapper">
                    <div class="timeline-labels"><span>${shot.start}</span><span>SHOT TIMELINE</span><span>${shot.end}</span></div>
                    <div class="timeline-box">
                        ${shot.workers.map(w => {
                            const totalFrames = shot.end - shot.start;
                            const offset = ((w.startFrame - shot.start) / totalFrames) * 100;
                            const width = ((w.endFrame - w.startFrame) / totalFrames) * 100;
                            return `
                            <div class="worker-block" style="left:${offset}%; width:${width}%; background: rgba(255,255,255,0.05);">
                                <div class="worker-fill" style="width:${w.progress}%; background-color:${w.color}; opacity:0.5"></div>
                                <div class="worker-label-min">${w.workerName}</div>
                            </div>`;
                        }).join('')}
                    </div>
                </div>
                <div>${workersHtml}</div>`;
            list.appendChild(shotEl);
        });
    }
</script>
</body>
</html>
